<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KanbanDo</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sortable-drag { 
            transform: rotate(5deg) scale(1.05) !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
            opacity: 0.9 !important;
            z-index: 1000 !important;
        }
        .sortable-ghost { 
            opacity: 0.3 !important;
        }
        .sortable-chosen {
            background: #dcfce7 !important;
            border-color: #22c55e !important;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-100 font-sans">
        <div class="max-w-7xl mx-auto p-5">
            <h1 class="text-center mb-8 text-3xl text-gray-700 font-light">KanbanDo</h1>
            <div class="flex gap-5 h-[90vh]">
                <div class="flex-1 bg-white rounded-lg p-5 shadow-lg transition-all duration-300 flex flex-col" v-for="status in statuses" :key="status.key">
                    <h3 class="text-sm font-semibold mb-4 uppercase text-gray-600">{{ status.name }}</h3>
                    <div :id="status.key" class="flex-1 min-h-0 transition-all duration-200">
                        <div v-for="task in getTasksByStatus(status.key)" :key="task.id" class="bg-gray-50 border border-gray-300 rounded p-3 mb-2.5 cursor-move transition-all duration-200 hover:bg-gray-100 hover:-translate-y-0.5 hover:shadow-md" :class="{ 'opacity-50': status.key === 'done' }" :data-id="task.id" @click="editTask(task)">
                            <div class="font-medium mb-1" :class="{ 'line-through': status.key === 'done' }">{{ task.title }}</div>
                            <div class="text-xs text-gray-600" v-if="task.description">{{ task.description }}</div>
                        </div>
                    </div>
                    <button v-if="status.key === 'done'" class="w-full py-2.5 px-2.5 border-2 border-dashed border-red-300 bg-transparent rounded cursor-pointer text-red-600 hover:border-red-500 hover:text-red-700 hover:bg-red-50 transition-colors mt-4" @click="deleteDoneTasks">Delete Done Tasks</button>
                    <button v-else class="w-full py-2.5 px-2.5 border-2 border-dashed border-gray-300 bg-transparent rounded cursor-pointer text-gray-600 hover:border-blue-500 hover:text-blue-500 transition-colors mt-4" @click="openModal(status.key)">+ Add Task</button>
                </div>
            </div>
        </div>

        <div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click="closeModal">
            <div class="bg-white p-8 rounded-lg w-96 max-w-[90%]" @click.stop>
                <h3 class="text-lg font-semibold mb-6">{{ editingTask ? 'Edit Task' : 'Add Task' }}</h3>
                <div class="mb-5">
                    <label class="block mb-1 font-medium">Title</label>
                    <input v-model="taskForm.title" placeholder="Task title" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-5">
                    <label class="block mb-1 font-medium">Description</label>
                    <textarea v-model="taskForm.description" placeholder="Task description" class="w-full px-3 py-2 border border-gray-300 rounded h-20 resize-y focus:outline-none focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-between">
                    <button class="px-5 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors" @click="saveTask">{{ editingTask ? 'Update' : 'Add' }}</button>
                    <button v-if="editingTask" class="px-3 py-1.5 text-red-500 text-sm hover:bg-red-50 rounded transition-colors" @click="confirmDeleteTask">Delete Task</button>
                </div>
            </div>
        </div>

        <div v-if="showDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click="closeDeleteModal">
            <div class="bg-white p-8 rounded-lg w-96 max-w-[90%]" @click.stop>
                <h3 class="text-lg font-semibold mb-6 text-red-600">Delete Completed Tasks</h3>
                <p class="mb-6 text-gray-700">Are you sure you want to delete {{ getDoneTasksCount() }} completed task{{ getDoneTasksCount() > 1 ? 's' : '' }}? This action cannot be undone.</p>
                <div class="flex justify-between">
                    <button class="px-5 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors" @click="closeDeleteModal">Cancel</button>
                    <button class="px-5 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors" @click="confirmDeleteDoneTasks">Delete Tasks</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    tasks: [],
                    showModal: false,
                    showDeleteModal: false,
                    editingTask: null,
                    taskForm: { title: '', description: '', status: 'todo' },
                    statuses: [
                        { key: 'todo', name: 'To Do' },
                        { key: 'progress', name: 'In Progress' },
                        { key: 'done', name: 'Done' }
                    ]
                }
            },
            async mounted() {
                await this.loadTasks();
                this.initSortable();
                this.setupKeyboardShortcuts();
            },
            methods: {
                async loadTasks() {
                    try {
                        const response = await fetch('api.php/tasks');
                        this.tasks = await response.json();
                    } catch (error) {
                        console.error('Error loading tasks:', error);
                    }
                },
                getTasksByStatus(status) {
                    return this.tasks.filter(task => task.status === status);
                },
                openModal(status = 'todo') {
                    this.taskForm = { title: '', description: '', status };
                    this.editingTask = null;
                    this.showModal = true;
                },
                editTask(task) {
                    this.taskForm = { ...task };
                    this.editingTask = task;
                    this.showModal = true;
                },
                closeModal() {
                    this.showModal = false;
                    this.editingTask = null;
                },
                async saveTask() {
                    if (!this.taskForm.title.trim()) return;
                    
                    try {
                        if (this.editingTask) {
                            await fetch(`api.php/tasks/${this.editingTask.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(this.taskForm)
                            });
                        } else {
                            await fetch('api.php/tasks', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(this.taskForm)
                            });
                        }
                        await this.loadTasks();
                        this.closeModal();
                    } catch (error) {
                        console.error('Error saving task:', error);
                    }
                },
                confirmDeleteTask() {
                    if (!confirm('Delete this task?')) return;
                    this.deleteTask(this.editingTask.id);
                },
                async deleteTask(id) {
                    try {
                        await fetch(`api.php/tasks/${id}`, { method: 'DELETE' });
                        await this.loadTasks();
                        this.closeModal();
                    } catch (error) {
                        console.error('Error deleting task:', error);
                    }
                },
                async updateTaskStatus(taskId, newStatus) {
                    const task = this.tasks.find(t => t.id == taskId);
                    if (task) {
                        task.status = newStatus;
                        try {
                            await fetch(`api.php/tasks/${taskId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(task)
                            });
                        } catch (error) {
                            console.error('Error updating task:', error);
                        }
                    }
                },
                initSortable() {
                    this.statuses.forEach(status => {
                        const element = document.getElementById(status.key);
                        Sortable.create(element, {
                            group: 'shared',
                            animation: 200,
                            easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                            ghostClass: 'sortable-ghost',
                            chosenClass: 'sortable-chosen',
                            dragClass: 'sortable-drag',
                            forceFallback: true,
                            fallbackTolerance: 3,
                            onStart: (evt) => {
                                document.body.style.cursor = 'grabbing';
                            },
                            onEnd: (evt) => {
                                document.body.style.cursor = '';
                                const taskId = evt.item.dataset.id;
                                const newStatus = evt.to.id;
                                this.updateTaskStatus(taskId, newStatus);
                            }
                        });
                    });
                },
                deleteDoneTasks() {
                    const doneTasks = this.tasks.filter(task => task.status === 'done');
                    if (doneTasks.length === 0) return;
                    this.showDeleteModal = true;
                },
                async confirmDeleteDoneTasks() {
                    try {
                        const doneTasks = this.tasks.filter(task => task.status === 'done');
                        for (const task of doneTasks) {
                            await fetch(`api.php/tasks/${task.id}`, { method: 'DELETE' });
                        }
                        await this.loadTasks();
                        this.closeDeleteModal();
                    } catch (error) {
                        console.error('Error deleting done tasks:', error);
                    }
                },
                closeDeleteModal() {
                    this.showDeleteModal = false;
                },
                getDoneTasksCount() {
                    return this.tasks.filter(task => task.status === 'done').length;
                },
                setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        // Escape key to dismiss modal
                        if (e.key === 'Escape' && this.showModal) {
                            this.closeModal();
                            return;
                        }
                        
                        // Escape key to dismiss delete modal
                        if (e.key === 'Escape' && this.showDeleteModal) {
                            this.closeDeleteModal();
                            return;
                        }
                        
                        // Cmd+Enter to save task when modal is open
                        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey) && this.showModal) {
                            e.preventDefault();
                            this.saveTask();
                            return;
                        }
                        
                        // Ctrl+Shift+N to open new task modal
                        if (e.key === 'N' && e.ctrlKey && e.shiftKey && !this.showModal && !this.showDeleteModal) {
                            e.preventDefault();
                            this.openModal();
                            return;
                        }
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>