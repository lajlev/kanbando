<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>KanbanDo</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .sortable-drag {
        transform: rotate(5deg) scale(1.05) !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
        opacity: 0.9 !important;
        z-index: 1000 !important;
      }
      .sortable-ghost {
        opacity: 0.3 !important;
      }
      .sortable-chosen {
        background: #dcfce7 !important;
        border-color: #22c55e !important;
      }
      .cursor-move {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
      }
      * {
        -webkit-user-drag: none;
      }
      .sortable-drag * {
        -webkit-user-select: none !important;
        -moz-user-select: none !important;
        -ms-user-select: none !important;
        user-select: none !important;
        pointer-events: none !important;
      }
      .drop-zone {
        border: 2px dashed #cbd5e1;
        transition: all 0.2s ease;
      }
      .drop-zone.drag-over {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }
      .image-preview {
        max-width: 100%;
        max-height: 150px;
        object-fit: cover;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div
      id="app"
      class="min-h-screen bg-gray-100 font-sans"
    >
      <div class="max-w-[80%] mx-auto p-5">
        <h1 class="text-center mb-8 text-3xl text-gray-700 font-light">
          Marmelade Ideas üçá üí°
        </h1>
        <div class="flex gap-5 h-[90vh] w-full">
          <div
            class="w-[30%] bg-white rounded-lg p-5 shadow-lg transition-all duration-300 flex flex-col"
            v-for="status in statuses"
            :key="status.key"
          >
            <h3 class="text-sm font-semibold mb-4 uppercase text-gray-600">
              {{ status.name }}
            </h3>
            <div
              :id="status.key"
              class="flex-1 min-h-0 transition-all duration-200"
            >
              <div
                v-for="task in getTasksByStatus(status.key)"
                :key="task.id"
                class="bg-gray-50 border border-gray-300 rounded p-3 mb-2.5 cursor-move transition-all duration-200 hover:bg-gray-100 hover:-translate-y-0.5 hover:shadow-md"
                :class="{ 'opacity-50': status.key === 'done' }"
                :data-id="task.id"
                @click="viewTask(task)"
              >
                <div
                  class="font-medium mb-1"
                  :class="{ 'line-through': status.key === 'done' }"
                >
                  {{ task.title }}
                </div>
                <div
                  class="text-xs text-gray-600"
                  v-if="task.description"
                >
                  {{ task.description }}
                </div>
                <div
                  v-if="getTaskImages(task).length > 0"
                  class="mt-2"
                >
                  <div class="flex gap-1 flex-wrap">
                    <img
                      v-for="(image, index) in getTaskImages(task).slice(0, 3)"
                      :key="index"
                      :src="'uploads/' + image"
                      class="w-12 h-12 object-cover rounded cursor-pointer hover:opacity-75 transition-opacity"
                      @click.stop="viewFullImage('uploads/' + image)"
                    />
                    <div 
                      v-if="getTaskImages(task).length > 3"
                      class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-xs text-gray-600 cursor-pointer hover:bg-gray-300"
                      @click.stop="viewTask(task)"
                    >
                      +{{ getTaskImages(task).length - 3 }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button
              v-if="status.key === 'done'"
              class="w-full py-2.5 px-2.5 border-2 border-dashed border-red-300 bg-transparent rounded cursor-pointer text-red-600 hover:border-red-500 hover:text-red-700 hover:bg-red-50 transition-colors mt-4"
              @click="deleteDoneTasks"
            >
              Delete Done Tasks
            </button>
            <button
              v-else
              class="w-full py-2.5 px-2.5 border-2 border-dashed border-gray-300 bg-transparent rounded cursor-pointer text-gray-600 hover:border-blue-500 hover:text-blue-500 transition-colors mt-4"
              @click="openModal(status.key)"
            >
              New Task
            </button>
          </div>
        </div>
      </div>

      <div
        v-if="showModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        @click="closeModal"
      >
        <div
          class="bg-white p-8 rounded-lg w-[36%] max-w-[90%]"
          @click.stop
        >
          <h3 class="text-lg font-semibold mb-6">
            {{ editingTask ? 'Edit Task' : 'Add Task' }}
          </h3>
          <div class="mb-5">
            <label class="block mb-1 font-medium">Title</label>
            <input
              v-model="taskForm.title"
              placeholder="Task title"
              class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500"
            />
          </div>
          <div class="mb-5">
            <label class="block mb-1 font-medium">Description</label>
            <textarea
              v-model="taskForm.description"
              placeholder="Task description"
              class="w-full px-3 py-2 border border-gray-300 rounded h-20 resize-y focus:outline-none focus:border-blue-500"
            ></textarea>
          </div>
          <div class="mb-5">
            <label class="block mb-1 font-medium">Image</label>
            <div
              class="drop-zone w-full p-4 border border-gray-300 rounded text-center cursor-pointer hover:bg-gray-50 transition-colors"
              :class="{ 'drag-over': isDragOver }"
              @click="$refs.fileInput.click()"
              @dragover.prevent="isDragOver = true"
              @dragleave.prevent="isDragOver = false"
              @drop.prevent="handleDrop"
              tabindex="0"
            >
              <div v-if="imagePreviews.length > 0">
                <div class="grid grid-cols-3 gap-2 mb-3">
                  <div v-for="(preview, index) in imagePreviews" :key="index" class="relative">
                    <img
                      :src="preview.url"
                      class="w-full h-20 object-cover rounded"
                    />
                    <button
                      type="button"
                      class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600"
                      @click.stop="removeImage(index)"
                    >
                      ‚úï
                    </button>
                  </div>
                </div>
                <div class="text-sm text-gray-600 text-center">
                  {{ imagePreviews.length }} image{{ imagePreviews.length === 1 ? '' : 's' }} selected
                </div>
              </div>
              <div
                v-else
                class="text-gray-500"
              >
                <div class="text-lg mb-1">üìé</div>
                <div>Drop images here, click to browse, or paste</div>
                <div class="text-xs mt-1">Max 5MB each ‚Ä¢ JPEG, PNG, GIF, WebP</div>
              </div>
            </div>
            <input
              ref="fileInput"
              type="file"
              accept="image/*"
              multiple
              class="hidden"
              @change="handleFileSelect"
            />
          </div>
          <div class="flex justify-between">
            <button
              class="px-5 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
              @click="saveTask"
            >
              {{ editingTask ? 'Update' : 'Add' }}
            </button>
            <button
              v-if="editingTask"
              class="px-3 py-1.5 text-red-500 text-sm hover:bg-red-50 rounded transition-colors"
              @click="confirmDeleteTask"
            >
              Delete Task
            </button>
          </div>
        </div>
      </div>

      <div
        v-if="showDeleteModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        @click="closeDeleteModal"
      >
        <div
          class="bg-white p-8 rounded-lg w-[36%] max-w-[90%]"
          @click.stop
        >
          <h3 class="text-lg font-semibold mb-6 text-red-600">
            Delete Completed Tasks
          </h3>
          <p class="mb-6 text-gray-700">
            Are you sure you want to delete {{ getDoneTasksCount() }} completed
            task{{ getDoneTasksCount() > 1 ? 's' : '' }}? This action cannot be
            undone.
          </p>
          <div class="flex justify-between">
            <button
              class="px-5 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
              @click="closeDeleteModal"
            >
              Cancel
            </button>
            <button
              class="px-5 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
              @click="confirmDeleteDoneTasks"
            >
              Delete Tasks
            </button>
          </div>
        </div>
      </div>

      <div
        v-if="showViewModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        @click="closeViewModal"
      >
        <div
          class="bg-white rounded-lg w-[36%] max-w-[90%] max-h-[80vh] overflow-y-auto shadow-2xl"
          @click.stop
        >
          <!-- Header with title and edit button -->
          <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-start mb-3">
              <h1
                class="text-xl font-bold text-gray-900 leading-tight"
                v-if="viewingTask"
              >
                {{ viewingTask.title }}
              </h1>
              <button
                class="ml-4 px-2 py-1 text-gray-400 hover:text-gray-600 hover:bg-gray-100 text-sm rounded transition-colors flex-shrink-0"
                @click="editFromView"
              >
                ‚úèÔ∏è
              </button>
            </div>

            <div
              class="flex items-center gap-3"
              v-if="viewingTask"
            >
              <span
                class="inline-block px-3 py-1 rounded-full text-sm font-medium"
                :class="{
                      'bg-yellow-100 text-yellow-800': viewingTask.status === 'todo',
                      'bg-blue-100 text-blue-800': viewingTask.status === 'progress', 
                      'bg-green-100 text-green-800': viewingTask.status === 'done'
                    }"
              >
                {{ getStatusName(viewingTask.status) }}
              </span>
              <span class="text-sm text-gray-500">
                üìÖ {{ formatDate(viewingTask.created_at) }}
              </span>
            </div>
          </div>

          <!-- Content -->
          <div
            class="p-6 cursor-pointer hover:bg-gray-50 transition-colors rounded-b-lg"
            @click="editFromView"
          >
            <div
              v-if="viewingTask && viewingTask.description"
              class="mb-6"
            >
              <div class="text-gray-700 leading-relaxed whitespace-pre-wrap">
                {{ viewingTask.description }}
              </div>
            </div>

            <div
              v-if="viewingTask && getTaskImages(viewingTask).length > 0"
              class="mb-6"
            >
              <div class="grid grid-cols-3 gap-2">
                <div 
                  v-for="(image, index) in getTaskImages(viewingTask)"
                  :key="index"
                  class="flex items-center justify-center h-24 bg-gray-50 rounded-lg overflow-hidden shadow-md cursor-pointer hover:opacity-75 transition-opacity"
                  @click.stop="viewFullImage('uploads/' + image)"
                >
                  <img
                    :src="'uploads/' + image"
                    class="max-w-full max-h-full object-contain"
                  />
                </div>
              </div>
            </div>

            <div
              v-if="!viewingTask || (!viewingTask.description && getTaskImages(viewingTask).length === 0)"
              class="text-gray-500 italic text-center py-8"
            >
              No additional details
              <div class="text-xs mt-2 text-gray-400">Click to add content</div>
            </div>
          </div>
        </div>
      </div>

      <div
        v-if="showImageModal"
        class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"
        @click="closeImageModal"
      >
        <div class="max-w-[90vw] max-h-[90vh] relative">
          <img 
            :src="fullSizeImage" 
            class="max-w-full max-h-full object-contain rounded-lg"
            @click.stop
          />
          <button
            class="absolute top-2 right-2 w-8 h-8 bg-black bg-opacity-50 text-white rounded-full flex items-center justify-center hover:bg-opacity-75 transition-opacity"
            @click="closeImageModal"
          >
            ‚úï
          </button>
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            tasks: [],
            showModal: false,
            showDeleteModal: false,
            showViewModal: false,
            showImageModal: false,
            editingTask: null,
            viewingTask: null,
            taskForm: {
              title: "",
              description: "",
              status: "todo",
              images: [],
            },
            imagePreviews: [],
            isDragOver: false,
            fullSizeImage: null,
            statuses: [
              { key: "todo", name: "Ideas" },
              { key: "progress", name: "In Progress" },
              { key: "done", name: "Done" },
            ],
          };
        },
        async mounted() {
          await this.loadTasks();
          this.initSortable();
          this.setupKeyboardShortcuts();
          this.setupPasteListener();
        },
        methods: {
          async loadTasks() {
            try {
              const response = await fetch("api.php/tasks");
              this.tasks = await response.json();
            } catch (error) {
              console.error("Error loading tasks:", error);
            }
          },
          getTasksByStatus(status) {
            return this.tasks.filter((task) => task.status === status);
          },
          openModal(status = "todo") {
            this.taskForm = { title: "", description: "", status, images: [] };
            this.editingTask = null;
            this.imagePreviews = [];
            this.showModal = true;
          },
          editTask(task) {
            this.taskForm = { ...task };
            this.editingTask = task;
            
            // Convert images to the new format
            const images = this.getTaskImages(task);
            this.taskForm.images = images;
            this.imagePreviews = images.map(img => ({
              filename: img,
              url: 'uploads/' + img
            }));
            
            this.showModal = true;
          },
          closeModal() {
            this.showModal = false;
            this.editingTask = null;
            this.imagePreviews = [];
            this.isDragOver = false;
          },
          async saveTask() {
            if (!this.taskForm.title.trim()) return;

            try {
              const wasEditing = !!this.editingTask;
              const taskId = this.editingTask?.id;

              if (this.editingTask) {
                await fetch(`api.php/tasks/${this.editingTask.id}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(this.taskForm),
                });
              } else {
                await fetch("api.php/tasks", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(this.taskForm),
                });
              }

              await this.loadTasks();
              this.closeModal();

              // If we were editing an existing task, return to view mode
              if (wasEditing && taskId) {
                const updatedTask = this.tasks.find((t) => t.id == taskId);
                if (updatedTask) {
                  this.viewTask(updatedTask);
                }
              }
            } catch (error) {
              console.error("Error saving task:", error);
            }
          },
          confirmDeleteTask() {
            if (!confirm("Delete this task?")) return;
            this.deleteTask(this.editingTask.id);
          },
          async deleteTask(id) {
            try {
              await fetch(`api.php/tasks/${id}`, { method: "DELETE" });
              await this.loadTasks();
              this.closeModal();
            } catch (error) {
              console.error("Error deleting task:", error);
            }
          },
          async updateTaskStatus(taskId, newStatus) {
            const task = this.tasks.find((t) => t.id == taskId);
            if (task) {
              task.status = newStatus;
              try {
                await fetch(`api.php/tasks/${taskId}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(task),
                });
              } catch (error) {
                console.error("Error updating task:", error);
              }
            }
          },
          initSortable() {
            this.statuses.forEach((status) => {
              const element = document.getElementById(status.key);
              Sortable.create(element, {
                group: "shared",
                animation: 200,
                easing: "cubic-bezier(0.4, 0, 0.2, 1)",
                ghostClass: "sortable-ghost",
                chosenClass: "sortable-chosen",
                dragClass: "sortable-drag",
                forceFallback: true,
                fallbackTolerance: 3,
                onStart: (evt) => {
                  document.body.style.cursor = "grabbing";
                },
                onEnd: (evt) => {
                  document.body.style.cursor = "";
                  const taskId = evt.item.dataset.id;
                  const newStatus = evt.to.id;
                  this.updateTaskStatus(taskId, newStatus);
                },
              });
            });
          },
          deleteDoneTasks() {
            const doneTasks = this.tasks.filter(
              (task) => task.status === "done"
            );
            if (doneTasks.length === 0) return;
            this.showDeleteModal = true;
          },
          async confirmDeleteDoneTasks() {
            try {
              const doneTasks = this.tasks.filter(
                (task) => task.status === "done"
              );
              for (const task of doneTasks) {
                await fetch(`api.php/tasks/${task.id}`, { method: "DELETE" });
              }
              await this.loadTasks();
              this.closeDeleteModal();
            } catch (error) {
              console.error("Error deleting done tasks:", error);
            }
          },
          closeDeleteModal() {
            this.showDeleteModal = false;
          },
          getDoneTasksCount() {
            return this.tasks.filter((task) => task.status === "done").length;
          },
          async handleFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
              await this.uploadImages(files);
            }
          },
          async handleDrop(event) {
            this.isDragOver = false;
            const files = Array.from(event.dataTransfer.files).filter(file => file.type.startsWith("image/"));
            if (files.length > 0) {
              await this.uploadImages(files);
            }
          },
          async uploadImages(files) {
            // Validate file sizes
            for (let file of files) {
              if (file.size > 5 * 1024 * 1024) {
                alert(`File "${file.name}" too large. Maximum size is 5MB`);
                return;
              }
            }

            const formData = new FormData();
            files.forEach(file => {
              formData.append("images[]", file);
            });

            try {
              const response = await fetch("upload.php", {
                method: "POST",
                body: formData,
              });

              const result = await response.json();

              if (result.success) {
                // Add new images to existing ones
                result.files.forEach(fileInfo => {
                  this.taskForm.images.push(fileInfo.filename);
                  this.imagePreviews.push({
                    filename: fileInfo.filename,
                    url: fileInfo.path
                  });
                });
              } else {
                alert("Upload failed: " + result.error);
              }
            } catch (error) {
              console.error("Upload error:", error);
              alert("Upload failed. Please try again.");
            }
          },
          removeImage(index) {
            this.taskForm.images.splice(index, 1);
            this.imagePreviews.splice(index, 1);
            if (this.$refs.fileInput) {
              this.$refs.fileInput.value = "";
            }
          },
          viewTask(task) {
            this.viewingTask = task;
            this.showViewModal = true;
          },
          closeViewModal() {
            this.showViewModal = false;
            this.viewingTask = null;
          },
          editFromView() {
            this.taskForm = { ...this.viewingTask };
            this.editingTask = this.viewingTask;
            
            // Convert images to the new format
            const images = this.getTaskImages(this.viewingTask);
            this.taskForm.images = images;
            this.imagePreviews = images.map(img => ({
              filename: img,
              url: 'uploads/' + img
            }));
            
            this.closeViewModal();
            this.showModal = true;
          },
          getStatusName(status) {
            const statusMap = {
              todo: "Ideas",
              progress: "In Progress",
              done: "Done",
            };
            return statusMap[status] || status;
          },
          formatDate(dateString) {
            if (!dateString) return "";
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMinutes < 1) {
              return "just now";
            } else if (diffMinutes < 60) {
              return `${diffMinutes} minute${diffMinutes === 1 ? "" : "s"} ago`;
            } else if (diffHours < 24) {
              return `${diffHours} hour${diffHours === 1 ? "" : "s"} ago`;
            } else if (diffDays < 30) {
              return `${diffDays} day${diffDays === 1 ? "" : "s"} ago`;
            } else {
              // For very old dates, fall back to absolute format
              const month = String(date.getMonth() + 1).padStart(2, "0");
              const day = String(date.getDate()).padStart(2, "0");
              const year = String(date.getFullYear()).slice(-2);
              return `${month}-${day}-${year}`;
            }
          },
          getTaskImages(task) {
            if (!task.image) return [];
            try {
              return JSON.parse(task.image);
            } catch (e) {
              return [];
            }
          },
          viewFullImage(imageSrc) {
            this.fullSizeImage = imageSrc;
            this.showImageModal = true;
          },
          closeImageModal() {
            this.showImageModal = false;
            this.fullSizeImage = null;
          },
          setupPasteListener() {
            document.addEventListener("paste", (e) => {
              // Only handle paste when modal is open
              if (!this.showModal) return;

              const items = e.clipboardData.items;
              const imageFiles = [];
              
              for (let item of items) {
                if (item.type.startsWith("image/")) {
                  const file = item.getAsFile();
                  if (file) {
                    imageFiles.push(file);
                  }
                }
              }
              
              if (imageFiles.length > 0) {
                e.preventDefault();
                this.uploadImages(imageFiles);
              }
            });
          },
          setupKeyboardShortcuts() {
            document.addEventListener("keydown", (e) => {
              // Escape key to dismiss modal
              if (e.key === "Escape" && this.showModal) {
                this.closeModal();
                return;
              }

              // Escape key to dismiss delete modal
              if (e.key === "Escape" && this.showDeleteModal) {
                this.closeDeleteModal();
                return;
              }

              // Escape key to dismiss view modal
              if (e.key === "Escape" && this.showViewModal) {
                this.closeViewModal();
                return;
              }

              // Cmd+Enter to save task when modal is open
              if (
                e.key === "Enter" &&
                (e.metaKey || e.ctrlKey) &&
                this.showModal
              ) {
                e.preventDefault();
                this.saveTask();
                return;
              }

              // Ctrl+Shift+N to open new task modal
              if (
                e.key === "N" &&
                e.ctrlKey &&
                e.shiftKey &&
                !this.showModal &&
                !this.showDeleteModal
              ) {
                e.preventDefault();
                this.openModal();
                return;
              }
            });
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
